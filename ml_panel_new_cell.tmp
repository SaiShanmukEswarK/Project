{
 "cell_type": "code",
 "execution_count": null,
 "id": "yearly-importances-plot-new",
 "metadata": {},
 "outputs": [],
 "source": [
  "# Plot top feature importances per year (RF per year)\n",
  "top_n_plot = 5\n",
  "importance_rows = []\n",
  "\n",
  "for yr in sorted(df_state_year['YEAR'].unique()):\n",
  "    df_y = df_state_year[df_state_year['YEAR'] == yr]\n",
  "    if df_y.shape[0] < 10:\n",
  "        continue\n",
  "    X_y = df_y[numeric_cols]\n",
  "    y_y = df_y[target_col]\n",
  "    rf_y = RandomForestRegressor(\n",
  "        n_estimators=300,\n",
  "        max_depth=10,\n",
  "        n_jobs=-1,\n",
  "        random_state=42,\n",
  "    )\n",
  "    rf_y.fit(X_y, y_y)\n",
  "    s = pd.Series(rf_y.feature_importances_, index=numeric_cols).nlargest(top_n_plot)\n",
  "    for feat, imp in s.items():\n",
  "        importance_rows.append({'YEAR': yr, 'feature': feat, 'importance': imp})\n",
  "\n",
  "if not importance_rows:\n",
  "    print('No per-year importances to plot (too few rows or data issues).')\n",
  "else:\n",
  "    imp_df = pd.DataFrame(importance_rows)\n",
  "    g = sns.catplot(\n",
  "        data=imp_df,\n",
  "        kind='bar',\n",
  "        x='importance', y='feature', hue='YEAR',\n",
  "        height=6, aspect=1.6,\n",
  "    )\n",
  "    g.fig.subplots_adjust(top=0.9)\n",
  "    g.fig.suptitle(f'Top {top_n_plot} feature importances per year (RF per year)')\n",
  "    g.set_axis_labels('Importance', 'Feature')\n",
  "    out_dir = Path('plots')\n",
  "    out_dir.mkdir(parents=True, exist_ok=True)\n",
  "    out_path = out_dir / 'yearly_feature_importances.png'\n",
  "    g.savefig(out_path, dpi=300, bbox_inches='tight')\n",
  "    print(f'Saved {out_path}')\n",
  "    plt.show()\n"
 ]
}
